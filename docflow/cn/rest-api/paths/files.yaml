/api/app-api/sip/platform/v2/file/upload:
  post:
    summary: 上传文件
    description: ""
    operationId: uploadFile
    parameters:
      - $ref: '../components/parameters.yaml#/WorkspaceId'
      - $ref: '../components/parameters.yaml#/Category'
      - $ref: '../components/parameters.yaml#/BatchNumber'
      - $ref: '../components/parameters.yaml#/AutoVerifyVat'
      - $ref: '../components/parameters.yaml#/SplitFlag'
      - $ref: '../components/parameters.yaml#/CropFlag'
      - $ref: '../components/parameters.yaml#/TargetProcess'
      - $ref: '../components/parameters.yaml#/ParserRemoveWatermark'
      - $ref: '../components/parameters.yaml#/ParserCropDewarp'
      - $ref: '../components/parameters.yaml#/ParserApplyMerge'
      - $ref: '../components/parameters.yaml#/ParserFormulaLevel'
      - $ref: '../components/parameters.yaml#/ParserTableTextSplitMode'
    requestBody:
      $ref: '../components/request-bodies.yaml#/FileUploadRequestBody'
    responses:
      '200':
        description: 文件上传成功
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../components/schemas/common.yaml#/CodeMessage'
              - type: object
                properties:
                  result:
                    type: object
                    properties:
                      batch_number:
                        type: string
                        description: 批次编号
                        example: 202412190001
                      files:
                        type: array   
                        items:
                          type: object
                          properties:
                            id:
                              type: string
                              description: 文件ID
                              example: 202412190001
                            task_id:
                              type: string
                              description: 任务ID
                              example: 1981692246135111680
                            name:
                              type: string
                              description: 文件名
                              example: invoice.pdf
                            format:
                              type: string
                              description: 文件格式
                              example: pdf
                          required:
                          - id
                          - name
                          - format
                    required:
                    - batch_number
                    - files

/api/app-api/sip/platform/v2/file/upload/sync:
  post:
    summary: 同步上传文件
    description: 同步上传文件并等待处理完成，返回处理结果
    operationId: uploadFileSync
    parameters:
      - $ref: '../components/parameters.yaml#/WorkspaceId'
      - $ref: '../components/parameters.yaml#/Category'
      - $ref: '../components/parameters.yaml#/BatchNumber'
      - $ref: '../components/parameters.yaml#/AutoVerifyVat'
      - $ref: '../components/parameters.yaml#/SplitFlag'
      - $ref: '../components/parameters.yaml#/CropFlag'
      - $ref: '../components/parameters.yaml#/TargetProcess'
      - $ref: '../components/parameters.yaml#/ParserRemoveWatermark'
      - $ref: '../components/parameters.yaml#/ParserCropDewarp'
      - $ref: '../components/parameters.yaml#/ParserApplyMerge'
      - $ref: '../components/parameters.yaml#/ParserFormulaLevel'
      - $ref: '../components/parameters.yaml#/ParserTableTextSplitMode'
      - $ref: '../components/parameters.yaml#/WithTaskDetailUrl'
    requestBody:
      $ref: '../components/request-bodies.yaml#/FileUploadRequestBody'
    responses:
      '200':
        description: 文件上传并处理成功
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../components/schemas/common.yaml#/CodeMessage'
              - $ref: '../components/schemas/files.yaml#/TaskProcessResult'

/api/app-api/sip/platform/v2/file/fetch:
  get:
    summary: 获取文件处理结果列表
    description: ""
    operationId: getFiles
    parameters:
      - name: page
        in: query
        description: 页码，默认1
        required: false
        schema:
          type: integer
          default: 1
      - name: page_size
        in: query
        description: 每页数量，默认1000
        required: false
        schema:
          type: integer
          default: 1000
      - name: workspace_id
        in: query
        description: 空间ID
        required: true
        schema:
          type: string
      - name: batch_number
        in: query
        description: 批次编号
        required: false
        schema:
          type: string
      - name: file_id
        in: query
        description: 文件ID
        required: false
        schema:
          type: string
      - name: category
        in: query
        description: 文件类别
        required: false
        schema:
          type: string
      - name: recognition_status
        in: query
        required: false
        schema:
          $ref: '../components/schemas/common.yaml#/RecognitionStatus'
      - name: verification_status
        in: query
        description: "文件核对状态 0: 待核对 2: 已确认 3: 已拒绝 4: 已删除 5: 推迟处理"
        required: false
        schema:
          $ref: '../components/schemas/common.yaml#/VerificationStatus'
      - name: start_time
        in: query
        description: 以更新时间搜索的开始时间, RFC3339格式(YYYY-MM-DDTHH:MM:SSZ)
        required: false
        schema:
          type: string
          format: date-time
          example: 2024-01-01T00:00:00Z
      - name: end_time
        in: query
        description: 以更新时间搜索的结束时间, RFC3339格式(YYYY-MM-DDTHH:MM:SSZ)
        required: false
        schema:
          type: string
          format: date-time
          example: 2024-01-01T10:00:00Z
      - name: with_document
        in: query
        description: 是否返回文档的全部文字识别结果
        required: false
        schema:
          type: boolean
          default: false
      - name: with_task_detail_url
        in: query
        description: 是否返回任务详情页URL
        required: false
        schema:
          type: boolean
          default: false
    responses:
      '200':
        description: 成功获取文件列表
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../components/schemas/common.yaml#/CodeMessage'
              - $ref: '../components/schemas/files.yaml#/TaskProcessResult'

/api/app-api/sip/platform/v2/file/delete:
  post:
    summary: 删除任务
    description: 按条件删除文件，满足任一条件即可删除。
    operationId: deleteFile
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              workspace_id:
                type: string
                description: 空间ID
                example: 1234567890
              batch_number:
                type: array
                items:
                  type: string
                description: 批次编号列表
                example: ["202412190001", "202412190002"]
              task_id:
                type: array
                items:
                  type: string
                description: 任务ID列表
                example: ["1978297791713619968", "1978297791713619969"]
              file_id:
                type: array
                items:
                  type: string
                description: 文件ID列表
                example: ["1978297792124661760", "1978297792124661761"]
              start_time:
                type: integer
                description: 开始时间（epoch时间戳，单位：秒）
                example: 1760523600
              end_time:
                type: integer
                description: 结束时间(epoch时间戳，单位：秒)
                example: 1760523600
            required:
              - workspace_id
    responses:
      '200':
        description: 成功删除任务
        content:
          application/json:
            schema:
              allOf:
                - $ref: '../components/schemas/common.yaml#/CodeMessage'
                - type: object
                  properties:
                    result:
                      type: object
                      properties:
                        deleted_count:
                          type: integer
                          description: 删除的文件数量
                          example: 1

/api/app-api/sip/platform/v2/file/update:
  post:
    summary: 更新文件处理结果
    description: 更新文件处理结果。通常用于人工审核校对后，上传修改后的key-value，覆盖自动识别的结果。
    operationId: updateFile
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: array
            items:
              type: object
              properties:
                workspace_id:
                  type: string
                  description: 空间ID
                  example: 1234567890
                file_id:
                  type: string
                  description: 文件ID
                  example: 202412190001
                data:
                  description: |
                    全量更新字段。  
                    注意，即使只更新部分字段，也必须包含所有字段。  
                    如果传入的字段较原字段多，则多出的字段会被添加。  
                    如果传入的字段较原字段少，则缺少的字段会被删除。  
                    如果传入的字段值较原字段值有变化，则字段值会被更新。  
                    如果传入的字段与原字段完全相同，则字段会被保留。
                  type: object
                  properties:
                    fields:
                      type: array
                      items:
                        $ref: '../components/schemas/files.yaml#/KeyValue'
                      example:
                      - key: 发票代码
                        value: "3100231130"
                        position:
                        - page: 0
                          vertices: [0, 0, 100, 0, 100, 100, 0, 100]
                      - key: 发票号码
                        value: "28737000"
                        position:
                        - page: 0
                          vertices: [0, 0, 100, 0, 100, 100, 0, 100]
                    items:
                      type: array
                      items:
                        type: array
                        items:
                          $ref: '../components/schemas/files.yaml#/KeyValue'
                      example:
                      - - key: 货物劳务名称
                          value: ＊电子计算机＊微型计算机主机
                          position:
                          - page: 0
                            vertices: [0, 0, 100, 0, 100, 100, 0, 100]
                        - key: 规格型号
                          value: DMS-SC68
                          position:
                          - page: 0
                            vertices: [0, 0, 100, 0, 100, 100, 0, 100]
                      - - key: 货物劳务名称
                          value: ＊机械计算机＊巨型计算机主机
                          position:
                          - page: 0
                            vertices: [0, 0, 100, 0, 100, 100, 0, 100]
                        - key: 规格型号
                          value: AN/FSQ-7
                          position:
                          - page: 0
                            vertices: [0, 0, 100, 0, 100, 100, 0, 100]
              required:
              - workspace_id
              - file_id
              - data
    responses:
      '200':
        description: 成功更新文件处理结果
        content:
          application/json:
            schema:
              allOf:
              - $ref: '../components/schemas/common.yaml#/CodeMessage'
              - type: object
                properties:
                  result:
                    type: object
                    properties:
                      files:
                        description: 更新后的文件列表
                        type: array
                        items:
                          type: object
                          properties:
                            workspace_id:
                              type: string
                              description: 空间ID
                              example: 1234567890
                            id:
                              type: string
                              description: 文件ID
                              example: 202412190001
    x-codeSamples:
      - lang: 'bash'
        label: cURL
        source: | 
          curl -X POST \
          -H 'x-ti-app-id: 1234567890' \
          -H 'x-ti-secret-code: 1234567890' \
          -d '[{"workspace_id": "1234567890", "file_id": "202412190001", "data": {"fields": [{"key": "发票代码", "value": "3100231130"}]}}]' \
          'https://docflow.textin.com/api/app-api/sip/platform/v2/file/update'

/api/app-api/sip/platform/v2/file/amend_category:
  post:
    summary: 修改文件类别
    description: |
      - 对于普通任务，修改普通任务文件类别
      - 对于文档拆分任务，修改拆分后的文件类型和页码
      - 对于多图切分任务，修改切分后的文件类型
    operationId: amendCategory
    requestBody:
      content:
        application/json:
          schema:
            type: object
            properties:
              workspace_id:
                type: string
                description: 空间ID
                example: 1234567890
              task_id:
                type: string
                description: 任务ID
                example: 1234567890
              category:
                type: string
                description: |
                  新文件类别。
                  只有当任务类型为普通任务时，才支持更新文件类别。
                example: 电子发票（普通发票）
              split_tasks:
                description: 文件拆分任务列表
                type: array
                items:
                  type: object
                  properties:
                    category:
                      type: string
                      description: 子任务文件类别
                      example: 电子发票（普通发票）
                    pages:
                      type: array
                      items:
                        type: integer
                        description: 子文件页码，从0开始计数
                      example: [0, 1]
              crop_tasks:
                description: 多图切分任务列表
                type: array
                items:
                  type: object
                  properties:
                    crop_child_task_id:
                      type: string
                      description: 多图切分子任务ID
                      example: 1234567890
                    category:
                      type: string
                      description: 子任务文件类别
                      example: 电子发票（普通发票）
            required:
              - workspace_id
              - task_id
    responses:
      '200':
        description: 成功更新文件类别
        content:
          application/json:
            schema:
              allOf:
                - $ref: '../components/schemas/common.yaml#/CodeMessage'

/api/app-api/sip/platform/v2/file/retry:
  post:
    summary: 重新处理文件
    description: 重新处理文件。
    operationId: retryFile
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              workspace_id:
                type: string
                description: 空间ID
                example: 1234567890
              task_id:
                type: string
                description: 任务ID
                example: 1234567890
              parser_params:
                $ref: '../components/schemas/files.yaml#/DocumentParserParam'
            required:
              - workspace_id
              - task_id
    responses:
      '200':
        description: 成功重新处理文件
        content:
          application/json:
            schema:
              allOf:
                - $ref: '../components/schemas/common.yaml#/CodeMessage'

/api/app-api/sip/platform/v2/file/extract_fields:
  post:
    summary: 抽取特定字段
    description: |
      针对已经完成抽取的任务，为该任务抽取额外的字段，或重新抽取个别已有的字段。  
      返回所有字段的完整抽取结果。返回结构同`/api/app-api/sip/platform/v2/file/fetch`。
    operationId: extractFields
    requestBody:
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              workspace_id:
                type: string
                description: 空间ID
                example: 1234567890
              task_id:
                type: string
                description: 任务ID
                example: 1234567890
              fields:
                type: array
                items:
                  $ref: '../components/schemas/files.yaml#/ExtractFieldReqVO'
              tables:
                type: array
                items:
                  type: object
                  properties:
                    name:
                      type: string
                      description: 表格名称
                      example: Table1
                    fields:
                      type: array
                      items:
                        $ref: '../components/schemas/files.yaml#/ExtractFieldReqVO'
            required:
              - workspace_id
              - task_id
    responses:
      '200':
        description: 成功提取字段
        content:
          application/json:
            schema:
              allOf:
                - $ref: '../components/schemas/common.yaml#/CodeMessage'
                - $ref: '../components/schemas/files.yaml#/TaskProcessResult'
